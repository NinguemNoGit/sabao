<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Retrocast - Modo Batocera</title>
  <!-- Estilo Retr√¥ -->
  <style>
    :root {
      --bg: #0f0f0f;
      --menu-bg: #181818;
      --selected-bg: #303030;
      --accent: #00ffcc;
      --text: #ffffff;
      --font: 'Courier New', monospace;
    }
    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg);
      color: var(--text);
      font-family: var(--font);
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    .menu {
      width: 260px;
      background: var(--menu-bg);
      padding: 2rem 1rem;
      box-shadow: 2px 0 10px rgba(0,0,0,0.7);
      overflow-y: auto;
      border-right: 1px solid #222;
    }
    .menu h2 {
      text-align: center;
      color: var(--accent);
      font-size: 1.4rem;
      margin-bottom: 2rem;
      letter-spacing: 1px;
    }
    .menu-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .menu-item:hover {
      background: var(--selected-bg);
    }
    .menu-item.selected {
      background: var(--accent);
      color: #000;
      font-weight: bold;
      border-radius: 6px;
    }
    .content {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      background: #111;
    }
    h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: var(--accent);
      border-left: 4px solid var(--accent);
      padding-left: 10px;
      margin-bottom: 1.5rem;
    }
    .game-list {
      list-style: none;
      padding-left: 0;
    }
    .game-list li {
      padding: 0.7rem 1rem;
      margin-bottom: 0.4rem;
      border-left: 3px solid transparent;
      border-bottom: 1px solid #da0000;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .game-list li:hover {
      background: #222;
      border-left: 3px solid var(--accent);
      padding-left: 1.2rem;
    }
    /* √çcone de Trof√©u */
    .game-list li img.trophy-icon {
      vertical-align: middle;
      margin-right: 10px;
      width: 20px;
      height: auto;
    }
    /* Notifica√ß√£o de Login */
    .ra-login-notification {
      position: fixed;
      z-index: 99999;
      padding: 1rem;
      background: #00ffcc;
      color: #000;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1rem;
      max-width: 300px;
      text-align: center;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    /* Notifica√ß√£o de Conquista */
    .achievement-notification {
      position: fixed;
      z-index: 99999;
      padding: 1rem;
      background: #111;
      color: #00ffcc;
      border-radius: 8px;
      font-family: monospace;
      font-size: 1rem;
      max-width: 300px;
      text-align: center;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    /* Posi√ß√µes da notifica√ß√£o */
    .pos-top-left { top: 20px; left: 20px; right: auto; }
    .pos-top-center { top: 20px; left: 50%; transform: translateX(-50%); }
    .pos-top-right { top: 20px; right: 20px; }
    .pos-bottom-left { bottom: 20px; left: 20px; top: auto; }
    .pos-bottom-center { bottom: 20px; left: 50%; transform: translateX(-50%); }
    .pos-bottom-right { bottom: 20px; right: 20px; top: auto; }
    /* Configura√ß√µes de Conquistas */
    .ra-settings {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .ra-settings label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    /* Tema Claro */
    body.light-mode {
      --bg: #f0f0f0;
      --menu-bg: #e0e0e0;
      --selected-bg: #d0d0d0;
      --accent: #0000cc;
      --text: #000000;
    }
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #ffee03;
      text-align: center;
      padding: 0.5rem;
      font-size: 0.85rem;
      color: #000000;
      border-top: 1px solid #222;
    }
  </style>
  <!-- Script do EmulatorJS -->
  <script src="data/loader.js"></script>
  <!-- M√≥dulo de Netplay -->
  <script src="data/netplay.js" defer></script>
  <!-- Scripts de Conquistas -->
  <script src="data/achievements/scripts/md5.js" defer></script>
  <script src="data/achievements/scripts/notify.js" defer></script>
</head>
<body>
  <!-- Menu Lateral -->
  <div class="menu">
    <h2>üéÆ Retrocast v1.0</h2>
    <div class="menu-item selected" data-section="consoles">üéÆ Consoles</div>
    <div class="menu-item" data-section="achievements">üéñÔ∏è Conquistas</div>
    <div class="menu-item" data-section="profile">üë§ Meu Perfil</div>
    <div class="menu-item" data-section="ranking">üèÜ Ranking</div>
    <div class="menu-item" data-section="tournament">ü•ä Torneio</div>
    <div class="menu-item" data-section="netplay">üïπÔ∏è Netplay</div>
    <div class="menu-item" data-section="saves">üíæ Saves</div>
    <div class="menu-item" data-section="voicechat">üé§ Chat de Voz</div>
  </div>
  <!-- Conte√∫do Principal -->
  <div class="content" id="content">
    <h2 id="section-title">üéÆ Consoles</h2>
    <div id="section-content"></div>
  </div>
  <!-- Tela de Carregamento -->
  <div id="display" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:black; z-index:9999; justify-content:center; align-items:center;">
    <div id="loading-content" style="text-align:center; color:#00ffcc;"></div>
  </div>
  <!-- Div onde o jogo vai rodar -->
  <div id="game" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh;"></div>
  <!-- Rodap√© opcional -->
  <div class="footer">
    Powered Retrocast Brasil v1.0 ‚Ä¢ Nostalgia sem Limites
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    window.emulatorLoaded = false;
    const menuItems = document.querySelectorAll(".menu-item");
    const sectionTitle = document.getElementById("section-title");
    const sectionContent = document.getElementById("section-content");
    let achievementsEnabled = false;

    // === LEITURA INICIAL (mantida)
    let raUser = localStorage.getItem("ra_username") || "";
    let raToken = localStorage.getItem("ra_api_key") || "";

    // === DADOS DO PERFIL NA NUVEM ===
    const API_URL = "http://localhost:4000/api";
    let userData = {
      name: localStorage.getItem("profile_name") || "",
      avatar: localStorage.getItem("profile_avatar") || "data/default-avatar.png",
      trophies: parseInt(localStorage.getItem("profile_trophies") || 0),
      wins: parseInt(localStorage.getItem("profile_wins") || 0),
      losses: parseInt(localStorage.getItem("profile_losses") || 0),
      rank: localStorage.getItem("profile_rank") || "Bronze",
      friends: JSON.parse(localStorage.getItem("profile_friends") || "[]"),
      cloudId: localStorage.getItem("profile_cloud_id") || null,
      token: localStorage.getItem("profile_token") || null
    };
    let socket = null;

    // === FUN√á√ÉO CORRIGIDA ===
    function loadSection(section) {
      raUser = localStorage.getItem("ra_username") || "";
      raToken = localStorage.getItem("ra_api_key") || "";

      sectionTitle.textContent = getSectionTitle(section);
      switch (section) {
        case "consoles":
          sectionContent.innerHTML = `
            <h3>üîå Selecione um Console</h3>
            <ul class='game-list'>
              <li onclick="loadConsole('nes')">NES ‚Äì Nintendo Entertainment System</li>
              <li onclick="loadConsole('snes')">SNES ‚Äì Super Nintendo</li>
              <li onclick="loadConsole('gb')">Game Boy / Color</li>
              <li onclick="loadConsole('gba')">Game Boy Advance</li>
              <li onclick="loadConsole('segaMD')">SEGA Genesis / Mega Drive</li>
              <li onclick="loadConsole('segaGG')">SEGA Game Gear</li>
              <li onclick="loadConsole('n64')">Nintendo 64</li>
              <li onclick="loadConsole('psx')">PlayStation</li>
              <li onclick="loadConsole('atari2600')">Atari 2600</li>
              <li onclick="loadConsole('arcade')">Arcade (MAME)</li>
            </ul>
          `;
          break;

        case "achievements":
          sectionContent.innerHTML = `
            <h3>üéñÔ∏è RetroAchievements</h3>
            <form id="ra-login-form" onsubmit="loginToRetroAchievements(); return false;">
              <input type="text" id="ra-username" placeholder="Nome de usu√°rio" value="${raUser}" required />
              <input type="password" id="ra-apikey" placeholder="Sua API Key" value="${raToken}" required />
              <button type="submit">üîê Entrar</button>
              <button type="button" onclick="logoutFromRetroAchievements()">üîå Sair</button>
              <button type="button" onclick="showAppearanceMenu()">üéõÔ∏è Apar√™ncia</button>
            </form>

            <div class="ra-header">
              <div class="ra-user" id="ra-user-info">${raUser ? 'Usu√°rio: ' + raUser : 'Usu√°rio: N√£o logado'}</div>
              <div class="ra-game" id="ra-game-title">Jogo: Nenhum carregado</div>
            </div>
            <div class="ra-progress" id="ra-game-progress">Progresso: 0/0</div>

            <div class="ra-settings">
              <label><input type="checkbox" id="ra-enable" ${localStorage.getItem("ra_enable") !== "false" ? "checked" : ""}> üéÆ Conquistas Ativadas</label>
              <label><input type="checkbox" id="ra-hardcore" ${localStorage.getItem("ra_hardcore") === "true" ? "checked" : ""}> üéÆ Modo Hardcore</label>
              <label><input type="checkbox" id="ra-sound" ${localStorage.getItem("ra_sound") !== "false" ? "checked" : ""}> üîä Som ativado</label>
              <label><input type="checkbox" id="ra-screenshot" ${localStorage.getItem("ra_screenshot") === "true" ? "checked" : ""}> üì∏ Tirar captura</label>
              <label><input type="checkbox" id="ra-unofficial" ${localStorage.getItem("ra_unofficial") === "true" ? "checked" : ""}> üß™ Mostrar conquistas n√£o oficiais</label>
              <label><input type="checkbox" id="ra-richpresence" ${localStorage.getItem("ra_richpresence") === "true" ? "checked" : ""}> üí¨ Mostrar Rich Presence</label>
              <button onclick="simulateUnlock()">üß™ Testar Conquista</button>
            </div>

            <div id="ra-achievements-list">
              <p>üîç Fa√ßa login para carregar as conquistas.</p>
            </div>
          `;
          break;

        case "profile":
          loadProfileSection();
          break;
        case "ranking":
          sectionContent.innerHTML = "<p>Ranking global em desenvolvimento.</p>";
          break;
        case "tournament":
          sectionContent.innerHTML = "<p>Torneios atuais: Em breve!</p>";
          break;
        case "netplay":
          sectionContent.innerHTML = `
            <h3>üïπÔ∏è NetPlay</h3>
            <p>Para jogar online:</p>
            <ol>
              <li><b>Host</b>: clique no jogo e escolha "Jogar online Netplay".</li>
              <li><b>Amigo</b>: clique no <b>mesmo jogo</b> e escolha "Jogar online Netplay".</li>
            </ol>
            <p>‚úÖ A sala √© criada automaticamente com o nome do jogo.</p>
          `;
          break;
        case "saves":
          sectionContent.innerHTML = "<p>Saves salvos localmente aparecer√£o aqui.</p>";
          break;
        case "voicechat":
          sectionContent.innerHTML = "<button onclick='startVoiceChat()'>üé§ Iniciar Chat de Voz</button>";
          break;
      }
    }

    function getSectionTitle(section) {
      const titles = {
        "consoles": "üéÆ Consoles",
        "achievements": "üéñÔ∏è Conquistas",
        "profile": "üë§ Meu Perfil",
        "ranking": "üèÜ Ranking",
        "tournament": "ü•ä Torneio",
        "netplay": "üïπÔ∏è Netplay",
        "saves": "üíæ Saves",
        "voicechat": "üé§ Chat de Voz"
      };
      return titles[section] || "Home";
    }

    async function loadConsole(consoleName) {
      sectionTitle.textContent = `üéÆ ${consoleName.toUpperCase()} Playlist`;
      try {
        const response = await fetch(`data/${consoleName}.json`);
        if (!response.ok) throw new Error(`Arquivo n√£o encontrado: data/${consoleName}.json`);
        const games = await response.json();
        if (!Array.isArray(games) || games.length === 0) {
          sectionContent.innerHTML = "<p>‚ùå Nenhum jogo encontrado.</p>";
          return;
        }
        let html = "<ul class='game-list'>";
        for (const game of games) {
          const hasTrophies = await hasAchievementsForGame(game.name);
          const trophyIcon = hasTrophies ? `<img src="data/achievements/icons/trophy.png" width="20" class="trophy-icon" />` : "";
          html += `<li onclick="promptNetplayMode('${game.name}', '${consoleName}', '${game.url}')">${trophyIcon} ${game.name}</li>`;
        }
        html += "</ul>";
        sectionContent.innerHTML = html;
      } catch (err) {
        console.error("Erro ao carregar playlist:", err);
        sectionContent.innerHTML = "<p>‚ö†Ô∏è Erro ao carregar jogos para este console.</p>";
      }
    }

    async function hasAchievementsForGame(gameName) {
      if (! raUser || !raToken) return false;
      try {
        const response = await fetch(`https://retroachievements.org/API/API_GetGameID.php?g=${encodeURIComponent(gameName)}&z=${raUser}&y=${raToken}`);
        const data = await response.json();
        return data?.GameID ? true : false;
      } catch (err) {
        console.error("Erro ao verificar conquistas:", err);
        return false;
      }
    }

    // ‚úÖ FUN√á√ÉO ATUALIZADA: Painel visual sem popup
    function promptNetplayMode(gameName, consoleName, romUrl) {
      const netplaySupported = ['nes', 'snes', 'gb', 'gbc', 'gba', 'segaMD', 'segaGG', 'fbalpha'];
      const isArcade = consoleName === 'arcade';
      const coreForNetplay = isArcade ? 'fbalpha' : consoleName;
      const canUseNetplay = netplaySupported.includes(coreForNetplay);

      const dialog = document.createElement("div");
      dialog.id = "netplay-choice";
      dialog.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 999999;
        font-family: var(--font);
        color: var(--text);
      `;

      const content = document.createElement("div");
      content.style.cssText = `
        background: #181818;
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--accent);
        text-align: center;
        max-width: 500px;
        width: 90%;
      `;

      content.innerHTML = `
        <h3 style="color: var(--accent); margin-top: 0;">üéÆ ${gameName}</h3>
        <p style="margin: 1.2rem 0; color: #ccc;">Escolha o modo de jogo:</p>
        <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1.5rem;">
          <button id="btn-offline-netplay" style="padding: 1rem; background: #ff3333; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-family: var(--font);">
            üíæ Jogar em modo offline
          </button>
          <button id="btn-online-netplay" style="padding: 1rem; background: var(--accent); color: #000; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-family: var(--font);">
            üåê Jogar online Netplay
          </button>
        </div>
        <p style="margin-top: 1.2rem; font-size: 0.85rem; color: #888;">
          ${!canUseNetplay ? '‚ö†Ô∏è Netplay n√£o suportado para este sistema.' : 'Netplay requer o mesmo jogo nos dois lados.'}
        </p>
      `;

      dialog.appendChild(content);
      document.body.appendChild(dialog);

      // Modo Offline
      document.getElementById("btn-offline-netplay").onclick = () => {
        document.body.removeChild(dialog);
        playGame(gameName, consoleName, romUrl, false, "", true);
      };

      // Modo Online (s√≥ se suportado)
      if (canUseNetplay) {
        document.getElementById("btn-online-netplay").onclick = () => {
          document.body.removeChild(dialog);
          
          const autoRoomId = gameName
            .toLowerCase()
            .replace(/[^a-z0-9]/g, '_')
            .substring(0, 24);

          // Pergunta simples: voc√™ √© o Host?
          const isHost = confirm(
            `üéÆ "${gameName}"\n\n‚úÖ Clique em "OK" se for o HOST.\n‚ùå Clique em "Cancelar" se for o AMIGO.`
          );
          playGame(gameName, consoleName, romUrl, true, autoRoomId, isHost);
        };
      } else {
        document.getElementById("btn-online-netplay").disabled = true;
        document.getElementById("btn-online-netplay").style.opacity = "0.5";
        document.getElementById("btn-online-netplay").style.cursor = "not-allowed";
      }
    }

    function playGame(gameName, consoleName, romUrl, useNetplay, netplayRoom, isHost = true) {
      if (!romUrl) {
        alert("‚ùå URL do jogo n√£o encontrada.");
        return;
      }

      const isArcade = consoleName === 'arcade';
      const coreForNetplay = isArcade ? 'fbalpha' : consoleName;

      document.querySelector('.menu').style.display = 'none';
      document.querySelector('.content').style.display = 'none';
      const displayDiv = document.getElementById('display');
      displayDiv.style.display = 'flex';
      document.getElementById('loading-content').innerHTML = `
        <div class="terminal-line">[Retrocast Brasil...]</div>
        <div class="terminal-line">Loading modules [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë] 100%</div>
        <div class="loader-text">${useNetplay ? (isHost ? 'üîÑ Criando sala...' : 'üîÑ Entrando na sala...') : 'üéÆ Carregando jogo...'}</div>
      `;

      // DEFINI√á√ÉO DAS VARI√ÅVEIS DO EMULATORJS (obrigat√≥rio antes do carregamento)
      window.EJS_player = "#game";
      window.EJS_gameName = gameName;
      window.EJS_biosUrl = "";
      window.EJS_gameUrl = romUrl;
      window.EJS_core = coreForNetplay;
      window.EJS_pathtodata = "data/";
      window.EJS_startOnLoaded = true;

      if (useNetplay) {
        window.EJS_netplay = true;
        // <-- AQUI: URL do seu Worker (com barra final)
        window.EJS_netplay_url = "wss://retrocast-netplay.retroarchbrasil2019.workers.dev/netplay/";
        window.EJS_netplay_room = netplayRoom;

        // ‚úÖ Servidores STUN + TURN para garantir conex√£o em qualquer rede
        window.EJS_netplayICEServers = [
          { urls: "stun:stun.l.google.com:19302" },
          { urls: "stun:stun1.l.google.com:19302" },
          { urls: "turn:openrelay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" },
          { urls: "turn:relay.metered.ca:80", username: "openrelayproject", credential: "openrelayproject" }
        ];
      } else {
        delete window.EJS_netplay;
      }

      function startEmulator() {
        document.getElementById('display').style.display = 'none';
        document.getElementById('game').style.display = 'block';

        // Reafirmar vari√°veis (evita erro EJS_player is not defined)
        window.EJS_player = "#game";
        window.EJS_core = coreForNetplay;
        window.EJS_pathtodata = "data/";

        EJS_load();

        if (useNetplay) {
          // Barra de status
          const netplayBar = document.createElement("div");
          netplayBar.id = "netplay-status-bar";
          netplayBar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: #00ffcc;
            text-align: center;
            padding: 8px;
            font-family: var(--font);
            font-size: 0.95rem;
            z-index: 10000;
            border-bottom: 1px solid #00ffcc;
          `;
          netplayBar.textContent = isHost 
            ? "üåê Sala criada! Aguardando jogador..." 
            : "üåê Entrando na sala...";
          document.body.appendChild(netplayBar);

          // Mostrar ID da sala s√≥ para o Host
          if (isHost) {
            const roomIdDisplay = document.createElement("div");
            roomIdDisplay.style.cssText = `
              position: fixed;
              bottom: 40px;
              left: 50%;
              transform: translateX(-50%);
              background: rgba(0,0,0,0.7);
              color: #00ffcc;
              padding: 6px 12px;
              border-radius: 4px;
              font-family: monospace;
              z-index: 9000;
            `;
            roomIdDisplay.textContent = `üÜî Sala: ${netplayRoom}`;
            document.body.appendChild(roomIdDisplay);
          }

          // INICIALIZAR O M√ìDULO DE NETPLAY
          if (typeof window.netplay !== 'undefined' && window.netplay.init) {
            window.netplay.init(isHost, netplayRoom);
          }

          // Notifica√ß√£o personalizada
          function showNetplayNotification(message) {
            const notify = document.createElement("div");
            notify.className = "achievement-notification pos-top-center";
            notify.style.cssText = `
              background: rgba(0,0,0,0.8);
              color: #00ffcc;
              padding: 12px;
              border-radius: 8px;
              font-family: var(--font);
              font-size: 1.1rem;
              z-index: 99999;
              opacity: 1;
              transition: opacity 0.5s ease;
            `;
            notify.textContent = message;
            document.body.appendChild(notify);
            setTimeout(() => {
              notify.style.opacity = "0";
              setTimeout(() => notify.remove(), 500);
            }, 3000);
          }

          // Intercepta mensagens do WebSocket
          const originalWebSocket = window.WebSocket;
          window.WebSocket = class extends originalWebSocket {
            constructor(url, protocols) {
              super(url, protocols);
              this.addEventListener('message', (event) => {
                try {
                  const msg = JSON.parse(event.data);
                  if (msg.type === "player_joined" && msg.total === 2) {
                    netplayBar.textContent = "üéÆ NetPlay: 2 jogadores conectados!";
                    netplayBar.style.color = "#00ff00";
                    showNetplayNotification("‚úÖ Player 2 conectado! Partida iniciada.");
                    // dispatch event for external handlers
                    document.dispatchEvent(new CustomEvent('EJS_NETPLAY_READY'));
                  }
                  if (msg.type === "player_id" && msg.id === 1) {
                    setTimeout(() => {
                      showNetplayNotification("‚úÖ Conectado √† sala do Host!");
                    }, 1000);
                  }
                } catch (e) {}
              });
            }
          };

          // Barra de identifica√ß√£o do jogador (Player 1 / Player 2)
          const playerBar = document.createElement("div");
          playerBar.id = "player-role-bar";
          playerBar.style.cssText = `
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #00ffcc;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: monospace;
            z-index: 9000;
          `;
          playerBar.textContent = isHost ? "üéÆ Player 1 (Host)" : "üéÆ Player 2 (Amigo)";
          document.body.appendChild(playerBar);
        }
      }

      if (!window.emulatorLoaded) {
        const script = document.createElement('script');
        script.src = "data/loader.js";
        script.onload = () => {
          window.emulatorLoaded = true;
          setTimeout(startEmulator, 2000);
        };
        script.onerror = () => alert("‚ùå Erro ao carregar data/loader.js");
        document.body.appendChild(script);
      } else {
        setTimeout(startEmulator, 2000);
      }
    }

    function startVoiceChat() {
      alert("Chat de voz iniciado!");
    }

    // === LOGIN NO RETROACHIEVEMENTS ===
    function loginToRetroAchievements() {
      const username = document.getElementById("ra-username").value.trim();
      const apikey = document.getElementById("ra-apikey").value.trim();

      if (!username || !apikey) {
        showNotification("error", "‚ùå Preencha usu√°rio e API Key.");
        return;
      }

      fetch(`https://retroachievements.org/API/API_GetUserProfile.php?z=${username}&y=${apikey}&u=${username}`)
        .then(res => res.json())
        .then(data => {
          if (data && data.DisplayName) {
            localStorage.setItem("ra_username", username);
            localStorage.setItem("ra_api_key", apikey);
            raUser = username;
            raToken = apikey;
            document.getElementById("ra-user-info").textContent = `Usu√°rio: ${data.DisplayName}`;
            showNotification("success", `‚úÖ Bem-vindo, ${data.DisplayName}!`);
            updateAchievementsList();
          } else {
            throw new Error("Credenciais inv√°lidas.");
          }
        })
        .catch(() => {
          showNotification("error", "‚ùå Falha ao autenticar. Verifique sua API Key.");
          logoutFromRetroAchievements();
        });
    }

    // === LOGOUT ===
    function logoutFromRetroAchievements() {
      localStorage.removeItem("ra_username");
      localStorage.removeItem("ra_api_key");
      raUser = "";
      raToken = "";
      document.getElementById("ra-user-info").textContent = "Usu√°rio: N√£o logado";
      document.getElementById("ra-game-title").textContent = "Jogo: Nenhum carregado";
      document.getElementById("ra-game-progress").textContent = "Progresso: 0/0";
      document.getElementById("ra-achievements-list").innerHTML = "<p>üîç Fa√ßa login para carregar as conquistas.</p>";
      showNotification("info", "üîå Desconectado.");
    }

    // === ATUALIZA LISTA DE CONQUISTAS ===
    function updateAchievementsList() {
      const list = document.getElementById("ra-achievements-list");
      list.innerHTML = `
        <p>üéÆ Conquistas ativadas para <strong>${raUser}</strong></p>
        <p>üí° As conquistas aparecer√£o ao jogar um jogo compat√≠vel.</p>
      `;
    }

    // === NOTIFICA√á√ïES ===
    function showNotification(type, message) {
      const existing = document.querySelector(".ra-login-notification, .achievement-notification");
      if (existing) existing.remove();
      const notify = document.createElement("div");
      notify.className = type === "success" ? "ra-login-notification" :
                        type === "error" ? "ra-login-notification" :
                        "achievement-notification";
      notify.classList.add("pos-top-right");
      notify.textContent = message;
      document.body.appendChild(notify);
      setTimeout(() => {
        notify.style.opacity = "0";
        setTimeout(() => notify.remove(), 500);
      }, 3000);
    }

    function showAppearanceMenu() {
      const currentTheme = localStorage.getItem("ra_theme") || "dark";
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      localStorage.setItem("ra_theme", newTheme);
      document.body.classList.toggle("light-mode", newTheme === "light");
      showNotification("info", `Tema: ${newTheme === "light" ? "Claro" : "Escuro"}`);
    }

    function simulateUnlock() {
      const notif = document.createElement("div");
      notif.className = "achievement-notification pos-bottom-right";
      notif.innerHTML = `<b>üèÜ Nova Conquista!</b><br>Teste: 10G`;
      document.body.appendChild(notif);
      setTimeout(() => {
        notif.style.opacity = "0";
        setTimeout(() => notif.remove(), 500);
      }, 5000);
    }

    // === PERFIL ===
    function loadProfileSection() {
      sectionTitle.textContent = "üë§ Meu Perfil";
      sectionContent.innerHTML = `
        <div class="profile-container" style="max-width: 600px; margin: 0 auto; font-family: var(--font); color: var(--text);">
          <div style="text-align: center; margin-bottom: 1.5rem;">
            <img id="profile-avatar" src="${userData.avatar}" alt="Avatar" 
                 style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); object-fit: cover;">
            <div style="margin-top: 0.8rem;">
              <input type="file" id="avatar-upload" accept="image/*" style="display:none">
              <button onclick="document.getElementById('avatar-upload').click()" 
                      style="background: #00ffcc; color: #000; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">
                üñºÔ∏è Alterar Avatar
              </button>
            </div>
          </div>
          <div style="margin-bottom: 1.5rem; text-align: center;">
            <input id="profile-name" type="text" placeholder="Seu nome de jogador" 
                   value="${userData.name}" 
                   style="width: 80%; max-width: 300px; padding: 0.7rem; background: #222; border: 1px solid var(--accent); color: var(--text); border-radius: 6px; text-align: center;">
            <button onclick="saveProfile()" 
                    style="margin-top: 0.5rem; background: var(--accent); color: #000; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
              üíæ Salvar Perfil
            </button>
          </div>
          <div id="profile-stats" style="background: #222; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
            <p>Carregando estat√≠sticas...</p>
          </div>
          <h3>üë• Amigos</h3>
          <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
            <input id="add-friend-name" type="text" placeholder="Nome do amigo" 
                   style="flex: 1; padding: 0.7rem; background: #222; border: 1px solid #444; color: var(--text); border-radius: 6px;">
            <button onclick="addFriend()" 
                    style="background: var(--accent); color: #000; border: none; width: 80px; border-radius: 6px; cursor: pointer; font-weight: bold;">
              ‚ûï Adicionar
            </button>
          </div>
          <ul id="friend-list" style="list-style: none; padding: 0; max-height: 150px; overflow-y: auto;"></ul>
          <h3 style="margin-top: 1.5rem;">‚òÅÔ∏è Conta na Nuvem</h3>
          <div style="display: flex; flex-direction: column; gap: 0.8rem;">
            <button onclick="loginWithGoogle()"
                    style="background: #4285F4; color: white; border: none; padding: 0.7rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
              üîó Vincular Google Drive
            </button>
            <button onclick="loginWithOneDrive()"
                    style="background: #0078D4; color: white; border: none; padding: 0.7rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
              üîó Vincular OneDrive
            </button>
            <button onclick="logoutFromCloud()"
                    style="background: #ff3333; color: white; border: none; padding: 0.7rem; border-radius: 6px; cursor: pointer; font-weight: bold;">
              üîê Sair da Nuvem
            </button>
          </div>
        </div>
      `;
      initProfile();
    }

    function initProfile() {
      document.getElementById("profile-avatar").src = userData.avatar;
      document.getElementById("profile-name").value = userData.name;
      updateStatsUI();
      renderFriends();
      document.getElementById("avatar-upload")?.addEventListener("change", e => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = evt => {
            userData.avatar = evt.target.result;
            document.getElementById("profile-avatar").src = userData.avatar;
            saveProfile();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function saveProfile() {
      const name = document.getElementById("profile-name").value.trim();
      if (!name) return alert("Nome vazio.");
      userData.name = name;
      userData.avatar = document.getElementById("profile-avatar").src;
      localStorage.setItem("profile_name", name);
      localStorage.setItem("profile_avatar", userData.avatar);
      showNotification("success", "Perfil salvo!");
    }

    function updateStatsUI() {
      document.getElementById("profile-stats").innerHTML = `
        <p>üèÜ ${userData.trophies} | ‚öîÔ∏è ${userData.wins} | üíÄ ${userData.losses}</p>
      `;
    }

    function addFriend() {
      const name = document.getElementById("add-friend-name").value.trim();
      if (!name || userData.friends.includes(name)) return;
      userData.friends.push(name);
      localStorage.setItem("profile_friends", JSON.stringify(userData.friends));
      renderFriends();
      showNotification("success", `Amigo ${name} adicionado!`);
    }

    function renderFriends() {
      const list = document.getElementById("friend-list");
      if (!list) return;
      list.innerHTML = userData.friends.length ? userData.friends.map(f => 
        `<li>${f} <button onclick="removeFriend('${f}')">X</button></li>`
      ).join("") : "<li>Nenhum amigo.</li>";
    }

    function removeFriend(name) {
      userData.friends = userData.friends.filter(f => f !== name);
      localStorage.setItem("profile_friends", JSON.stringify(userData.friends));
      renderFriends();
    }

    // === MENU E CONTROLE ===
    menuItems.forEach(item => {
      item.addEventListener("click", () => {
        menuItems.forEach(i => i.classList.remove("selected"));
        item.classList.add("selected");
        loadSection(item.dataset.section);
      });
    });

    if ('getGamepads' in navigator) {
      let selectedIndex = 0;
      function poll() {
        const gamepads = navigator.getGamepads();
        for (const gp of gamepads) {
          if (gp) {
            if (gp.axes[1] < -0.5) navigate(-1);
            if (gp.axes[1] > 0.5) navigate(1);
            if (gp.buttons[0].pressed) menuItems[selectedIndex].click();
          }
        }
        requestAnimationFrame(poll);
      }
      function navigate(dir) {
        menuItems[selectedIndex].classList.remove("selected");
        selectedIndex = Math.max(0, Math.min(menuItems.length - 1, selectedIndex + dir));
        menuItems[selectedIndex].classList.add("selected");
      }
      poll();
    }

    // Inicia no menu de consoles
    loadSection("consoles");
  </script>

  <!-- ===========================
       NETPLAY CLIENT (ADICIONADO)
       =========================== -->
  <script>
    (function(){
      // URL exata do seu Worker com barra final (conforme voc√™ informou)
      const NETPLAY_WSS_BASE = "wss://retrocast-netplay.retroarchbrasil2019.workers.dev/netplay/";

      // Estado interno
      let ws = null;
      let currentRoom = null;
      let isHost = false;
      let playerId = null;
      let connected = false;
      let reconnectTimer = null;

      // Expor objeto global
      window.netplay = {
        init,
        sendInput,
        close
      };

      // Inicializa netplay: isHost boolean, room string
      function init(hostFlag, room) {
        isHost = !!hostFlag;
        currentRoom = room || "default";
        openSocket();
      }

      function openSocket() {
        close(); // limpa se houver algo

        try {
          const url = NETPLAY_WSS_BASE + "?room=" + encodeURIComponent(currentRoom);
          ws = new WebSocket(url);
        } catch (e) {
          dispatchError("failed_to_create_socket");
          return;
        }

        ws.addEventListener('open', () => {
          connected = true;
          // enviar identifica√ß√£o inicial (opcional)
          ws.send(JSON.stringify({ type: "hello", isHost: !!isHost }));
          // dispatch connected
          document.dispatchEvent(new CustomEvent('EJS_NETPLAY_CONNECTED', { detail: { room: currentRoom, isHost } }));
        });

        ws.addEventListener('message', (evt) => {
          try {
            const msg = JSON.parse(evt.data);
            handleMessage(msg);
          } catch (e) {
            // mensagem n√£o-json -> ignorar
          }
        });

        ws.addEventListener('close', () => {
          connected = false;
          document.dispatchEvent(new CustomEvent('EJS_NETPLAY_DISCONNECTED', { detail: { room: currentRoom } }));
          // tentar reconectar breve (apenas uma tentativa simples)
          if (!reconnectTimer) {
            reconnectTimer = setTimeout(() => {
              reconnectTimer = null;
              openSocket();
            }, 2000);
          }
        });

        ws.addEventListener('error', (err) => {
          dispatchError("socket_error");
        });
      }

      function handleMessage(msg) {
        // mensagens esperadas do seu Worker/relay
        if (!msg || !msg.type) return;

        if (msg.type === "player_id") {
          playerId = msg.id;
          // pequeno delay para garantir UI
          setTimeout(() => {
            document.dispatchEvent(new CustomEvent('EJS_NETPLAY_PLAYER_ID', { detail: { id: playerId } }));
          }, 150);
        }

        if (msg.type === "player_joined") {
          // { type: "player_joined", total: N }
          document.dispatchEvent(new CustomEvent('EJS_NETPLAY_PLAYER_JOINED', { detail: msg }));
          if (msg.total === 2) {
            // pronto para jogar
            document.dispatchEvent(new CustomEvent('EJS_NETPLAY_READY', { detail: msg }));
          }
        }

        if (msg.type === "input") {
          // payload do jogador remoto
          // msg.payload ‚Äî depende de como voc√™ envia (padr√£o: { action, key, pressed })
          const payload = msg.payload;
          // se existe fun√ß√£o netplayInput no emulador, chama
          if (window.emulator && typeof window.emulator.netplayInput === 'function') {
            try { window.emulator.netplayInput(payload); } catch(e) {}
          }
          // tamb√©m emitir evento para ser capturado por outros m√≥dulos
          document.dispatchEvent(new CustomEvent('EJS_NETPLAY_REMOTE_INPUT', { detail: payload }));
        }

        // repassar pings/pongs ou outras mensagens conforme necessidade
        if (msg.type === "ping") {
          // responder pong (se quiser)
          try { ws.send(JSON.stringify({ type: "pong" })); } catch(e){}
        }
      }

      // enviar input para o outro jogador
      function sendInput(payload) {
        if (!ws || ws.readyState !== WebSocket.OPEN) return false;
        try {
          ws.send(JSON.stringify({ type: "input", payload: payload }));
          return true;
        } catch(e){
          return false;
        }
      }

      function close() {
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
        if (ws) {
          try { ws.close(); } catch(e) {}
          ws = null;
        }
        connected = false;
        playerId = null;
      }

      function dispatchError(code) {
        document.dispatchEvent(new CustomEvent('EJS_NETPLAY_ERROR', { detail: { code } }));
      }

      // Tornar dispon√≠vel globalmente tamb√©m (compatibilidade)
      window.netplaySendInput = sendInput;
    })();
  </script>

  <!-- ===========================
       FIM DO NETPLAY CLIENT
       =========================== -->

</body>
</html>
